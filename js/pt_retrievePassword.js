(function(){var using=NEJ.P;var merge=NEJ.X;var e=using("nej.e");var v=using("nej.v");var u=using("nej.u");var j=using("nej.j");var du=using("dd.util");var dw=using("dd.widget");var view={parent:e._$get("box"),onBlur:function(event){var input=v._$getElement(event);if(["password","repassword"].indexOf(input.name)==-1&&this.validate(input.name)===false){this.onValidateError()}},validate:function(name){if(Array.isArray(name)){for(var i=0;x=name[i];i++){if(!this.validate(x))return false}return true}else{var input=this.form[name];var value=input&&input.value.trim();var title=this.getTitle(name);this.error={code:name};if(!value){this.error.message=title+"不能为空";return}if(this.validator[name]&&!this.validator[name](value)){this.error.message=title+"格式错误";return false}if(["password","repassword"].indexOf(name)!==-1){var password=this.form["password"].value;var repassword=this.form["repassword"].value;if(password&&repassword&&password!==repassword){this.error.message="两次输入的密码不一致";return false}}return true}},onValidateError:function(){if(!this.error||!this.error.message)return;var input=this.form[this.error.code];du.showError(this.error.message);if(input){input.focus()}},go:function(id,data){var sn="jst-"+id;e._$parseTemplate(sn);e._$renderHtmlTemplate(this.parent,sn,data)},gather:function(names){if(!names||!names.forEach)return;var data={};names.forEach(function(name){data[name]=this.form[name].value.trim()}._$bind(this));return data},disabled:function(flag){var submitBtn=this.form["submit"];submitBtn.disabled=flag;if(flag){e._$addClassName(submitBtn,"u-btn-dis")}else{e._$delClassName(submitBtn,"u-btn-dis")}},getTitle:function(name){var input=this.form[name];if(input){tr=du.findAncestor(input,function(node){return node.tagName.toLowerCase()==="tr"},this.form);th=tr&&tr.getElementsByTagName("th")[0];return th&&th.innerText.trim()}}};var verifyView={init:function(){e._$parseTemplate("template-box");this.initDom();this.initEvent();this.validator=du.validator;dw._$$SMSSender._$allocate({parent:e._$one(".sms"),phone:"[name=mobile]"})},initDom:function(){this.form=this.parent.getElementsByTagName("form")[0];this.form["email"].focus()},initEvent:function(){["email","id","mobile"].forEach(function(name){v._$addEvent(this.form[name],"blur",this.onBlur._$bind(this))}._$bind(this));v._$addEvent(this.form["submit"],"click",this.onClickSubmit._$bind(this))},onClickSendSms:function(event){this.sendSms()},sendSms:function(){var mobile=this.form["mobile"].value.trim();if(!this.validator["mobile"](mobile)){du.showError("请先填写正确的手机号码");this.form["mobile"].focus()}else{j._$requestByREST("/rest/sms",{method:"POST",type:"json",data:{mobile:mobile},onload:this.cbSendSms._$bind(this)})}},cbSendSms:function(json){if(json&&json.code===200){this.disabledResend(true);e._$get("sendSms").style.display="none";e._$get("smsText").style.display="";this.form["sms"].focus();this.second=50;this.timer=window.setInterval(this.countDown._$bind(this),1e3)}else{du.showError(json.message||"发送失败，请稍后再试！")}},countDown:function(){if(this.second<=0){window.clearInterval(this.timer);delete this.timer;this.disabledResend(false)}else{e._$get("second").innerText=--this.second}},onClickResendSms:function(event){if(e._$hasClassName("resend","z-disabled"))return;this.sendSms()},disabledResend:function(flag){if(flag){e._$addClassName("resend","z-disabled")}else{e._$delClassName("resend","z-disabled")}},onClickSubmit:function(event){var names=["email","id","mobile","sms"];if(this.validate(names)){this.disabled(true);j._$requestByREST("/rest/accounts/verify",{method:"POST",type:"json",data:this.gather(names),onload:this.cbVerifyAccount._$bind(this)})}else{this.onValidateError()}},cbVerifyAccount:function(json){this.disabled(false);if(json&&json.result){this.go("reset",{email:this.form["email"].value.trim()});resetView.init()}else{du.showError(json&&json.message||"信息验证失败，请稍后再试！")}}};var resetView={init:function(){this.initDom();this.initEvent();this.validator=du.validator;this.validator["repassword"]=this.validator["password"]},initDom:function(){this.form=this.parent.getElementsByTagName("form")[0];this.form["password"].focus()},initEvent:function(){["password","repassword"].forEach(function(name){v._$addEvent(this.form[name],"blur",this.onBlur._$bind(this))}._$bind(this));v._$addEvent(this.form["submit"],"click",this.onClickSubmit._$bind(this))},onClickSubmit:function(event){if(this.validate("password","repassword")){this.disabled(true);var data=this.gather(["password"]);data.password=u._$md52hex(data.password);j._$requestByREST("/rest/password",{method:"POST",type:"json",data:data,onload:this.cbUpdatePassword._$bind(this)})}else{this.onValidateError()}},cbUpdatePassword:function(json){this.disabled(false);if(json&&json.result){this.go("success")}else{du.showError(json&&json.message||"设置新密码失败，请稍后再试！")}}};merge(verifyView,view);merge(resetView,view);verifyView.init()})()