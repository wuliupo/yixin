(function(){var using=NEJ.P;var merge=NEJ.X;var e=using("nej.e");var v=using("nej.v");var u=using("nej.u");var t=using("nej.ut");var j=using("nej.j");var du=using("dd.util");var $=du.$;var dw=using("dd.widget");var form,error,second,timer;var validator={nick:function(str){var length=u._$length(str);return length>0&&length<=20},organization:function(str){if(!str)return;return u._$length(str)<=200}};function init(){e._$parseTemplate("template-box");initDom();initEvent();merge(validator,du.validator);validator["repassword"]=validator["password"];validator["duty"]=validator["address"]=validator["organization"];dw._$$SMSSender._$allocate({parent:e._$one(".sms"),phone:"[name=mobile]"})}function initDom(){form=e._$get("form");form["email"].focus();var param={type:1,size:"5M",extension:["jpg","jpeg","bmp","gif"],name:"uri"};this.__upload=dw._$$Upload._$allocate(merge({parent:"upload",action:"/upload/register",onmessage:listener._$bind(null,param)},param));var docParam={type:1004,extension:["doc","docx"],name:"docUri"};this.__docUpload=dw._$$Upload._$allocate(merge({parent:"docUpload",btnTxt:"上传登记资料表",action:"/upload/register",retry:"重传登记资料表",onmessage:listener._$bind(null,docParam)},docParam));this.__region=t._$$RegionSelector._$allocate({province:form["province"],city:form["city"],data:{province:e._$attr(form["province"],"data-value")||"浙江省",city:e._$attr(form["city"],"data-value")||"杭州市"}});var authorityParam={type:1,extension:["jpg","jpeg","bmp","gif"],name:"authorityUri"};this.__docUpload=dw._$$Upload._$allocate(merge({parent:"authorityUpload",btnTxt:"上传授权书",action:"/upload/register",retry:"重传授权书",onmessage:listener._$bind(null,authorityParam)},authorityParam));resetLevel()}function initEvent(){["email","password","repassword","nick","id","mobile","phone","organization","duty","address"].forEach(function(name){v._$addEvent(form[name],"blur",onBlur)});v._$addEvent(form["level"],"change",onChangeLevel);var radios=form["verifyFollow"];v._$addEvent(radios[0],"click",onClickVerifyFollow);v._$addEvent(radios[1],"click",onClickVerifyFollow);v._$addEvent("updateCaptcha","click",onClickUpdateCaptcha);v._$addEvent("service","click",onClickService);v._$addEvent("submit","click",onClickSubmit)}function onBlur(event){var input=v._$getElement(event);var name=input.name;if(validate(name)===false){onValidateError()}if(name==="email"&&validate("email")){j._$requestByREST("/rest/email/check",{method:"POST",type:"json",data:{email:form["email"].value.trim()},onload:cbCheckEmail})}}function cbCheckEmail(json){if(json&&json.result){error={code:"email",message:"邮箱已经被注册"};onValidateError()}}function onChangeLevel(event){var select=v._$getElement(event);e._$get("verifyHint").style.display="none";var radios=form["verifyFollow"];for(var i=0,radio;radio=radios[i];i++){radio.checked=!parseInt(radio.value)}resetLevel()}function resetLevel(){var select=e._$one("select[name=level]");if(select.value==="2"){e._$get("doc").style.display="none"}else{e._$get("doc").style.display="";e._$get("qydjb").style.display=select.value==="0"?"":"none";e._$get("zzdjb").style.display=select.value==="1"?"":"none";e._$get("zfjgdjb").style.display=select.value==="3"?"":"none"}e._$get("authority").style.display=select.value==="2"?"none":"";e._$get("organization").style.display=select.value==="2"?"":"none";e._$get("address").style.display=select.value==="2"?"":"none"}function onClickVerifyFollow(event){var radio=v._$getElement(event);if(radio.value==="0"){e._$get("verifyHint").style.display="none"}else{e._$get("verifyHint").style.display=""}}function onClickSendSms(event){sendSms()}function sendSms(){var mobile=form["mobile"].value.trim();if(!validator["mobile"](mobile)){du.showError("请先填写正确的手机号码");form["mobile"].focus()}else{j._$requestByREST("/rest/sms",{method:"POST",type:"json",data:{mobile:mobile},onload:cbSendSms})}}function cbSendSms(json){if(json&&json.code===200){disabledResend(true);e._$get("sendSms").style.display="none";e._$get("smsText").style.display="";form["sms"].focus();second=50;timer=window.setInterval(countDown,1e3)}else{du.showError(json.message||"发送失败，请稍后再试！")}}function countDown(){if(second<=0){window.clearInterval(timer);timer=undefined;disabledResend(false)}else{e._$get("second").innerText=--second}}function onClickResendSms(event){if(e._$hasClassName("resend","z-disabled"))return;sendSms()}function disabledResend(flag){if(flag){e._$addClassName("resend","z-disabled")}else{e._$delClassName("resend","z-disabled")}}function onClickUpdateCaptcha(event){updateCaptcha()}function updateCaptcha(){var captchaImg=e._$get("captcha");captchaImg.src=captchaImg.getAttribute("src",2).replace(/(?:\?t=\d+)?$/,"?t="+Date.now())}function onClickService(event){disabled(!v._$getElement(event).checked)}function disabled(flag){var submitBtn=e._$get("submit");submitBtn.disabled=flag;if(flag){e._$addClassName("submit","z-dis");submitBtn.title="同意《易信公众平台服务协议》，开始注册"}else{e._$delClassName("submit","z-dis");submitBtn.title=""}}function onClickSubmit(event){if(validate(getValidateNames())){disabled(true);var data=gather();data.password=u._$md52hex(data.password);var url="/rest/"+(window.isPUT?"reR":"r")+"egister"+(window.fromDianxin?"?from=dianxin":"");j._$requestByREST(url,{method:"POST",type:"json",data:data,onload:cbRegister})}else{onValidateError(true)}}function escapeData(){}function getValidateNames(){var result=[];["email","password","repassword","nick","docUri","authorityUri","name","id","uri","mobile","sms","phone","organization","duty","address","captcha"].forEach(function(name){var input=form[name];if(isValidate(input)){result.push(name)}});return result}function isValidate(input){var tr=du.findAncestor(input,function(node){return node.tagName.toLowerCase()==="tr"});if(tr){if(tr.style.display==="none"){return false}else{var node=tr;while(node&&node.tagName.toLowerCase()!=="form"){if(node.style.display==="none"){return false}node=node.parentNode}return true}}return false}function validate(name){if(Array.isArray(name)){for(var i=0;x=name[i];i++){if(!validate(x))return false}return true}else{var input=form[name];var value=input&&input.value;if(["password","repassword"].indexOf(name)===-1){value=value.trim()}var title=getTitle(name);error={code:name};if(!value&&!(name=="phone"&&isOptionlPhone())){error.message=["authorityUri","docUri","uri"].indexOf(name)!==-1?"必须上传"+title:title+"不能为空";return}if(["email","password","repassword","nick","id","mobile","phone"].indexOf(name)!==-1&&!validator[name](value)){if(name=="phone"&&isOptionlPhone()&&value=="")return true;if(name==="nick"){error.message=title+"字数超过限制"}else{error.message=title+"格式错误"}return false}if(["organization","duty","address"].indexOf(name)!==-1&&validator[name](value)===false){error.message=title+"不超过100汉字";return false}if(["password","repassword"].indexOf(name)!==-1){var password=form["password"].value;var repassword=form["repassword"].value;if(password&&repassword&&password!==repassword){error.message="两次输入的密码不一致";return false}}return true}}function onValidateError(opt_isIntoView){if(!error||!error.message)return;var input=form[error.code];du.showError(error.message);if(input){if(opt_isIntoView){input.scrollIntoView()}}}function gather(){var data={};if(form["pid"])data["pid"]=form["pid"].value.trim();["email","password","nick","level","docUri","name","id","uri","mobile","sms","province","city","phone","organization","duty","authorityUri","address","captcha"].forEach(function(name){if(form[name]){if(~["signature","province","city"].indexOf(name)){data[name]=u._$escape(form[name].value).trim()}else{data[name]=form[name].value.trim()}}});data["verifyFollow"]=getRadioValue("verifyFollow");if(form["level"].value=="2"){data["docUri"]="";data["authorityUri"]=""}return data}function getRadioValue(name){var radios=form[name];for(var i=0,radio;radio=radios[i];i++){if(radio.checked){return parseInt(radio.value)}}}function cbRegister(json){disabled(false);if(json&&json.code===200){e._$get("step0").style.display="none";e._$get("step1").style.display="";e._$get("email").innerText=form["email"].value.trim()}else{du.showError(json&&json.message||"注册失败，请稍后再试！");updateCaptcha()}}function isOptionlPhone(){return form["level"].value=="2"}function listener(param,event){du.onUploaderMessage(event,param);if(event.type==="uploaded"&&event.data.code===200){onUpload(event.data,param.name)}}function onUpload(data,name){var result=data&&data.result;if(result){du.showSuccess("上传成功");var viewNode=e._$get(name);if(viewNode){viewNode.src=du.transUri(result.uri)}var fileNameNode=e._$get(name+"_fileName");if(fileNameNode){var $imgwrap=$(fileNameNode)._$parent(".iptarea",true)._$find(".imgwrap")._$addClassName("imgwrap-select");$imgwrap._$find(".doc")._$text(result.fileName)._$attr({title:result.fileName});if($imgwrap._$hasClassName("imgwrap-zz")){$imgwrap._$find("img")._$attr("src",du.transUri(result.uri))}}form[name].value=result.uri}else{du.showError("上传失败，请稍后再试！")}}function getTitle(name){var input=form[name];if(input){tr=du.findAncestor(input,function(node){return node.tagName.toLowerCase()==="tr"},form);th=tr&&tr.getElementsByTagName("th")[0];return th&&th.innerText.trim()}}init()})()